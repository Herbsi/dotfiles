#!/usr/bin/env uv run --script
# -*- mode: python -*-
# /// script
# dependencies = [
#   "click",
#   "polars",
# ]
# ///
import datetime
import subprocess
import tempfile
from pathlib import Path

import click
import polars as pl


@click.command()
@click.argument("filename", type=click.Path(exists=True, path_type=Path))
def main(filename):
    with tempfile.TemporaryDirectory() as tmp_dir:
        tmp_dir = Path(tmp_dir)
        output_file = tmp_dir / "transactions.csv"
        query = r'SELECT date, account, CONVERT(position, "CHF") AS position WHERE (NOT account ~ "Vacation");'
        command = [
            "bean-query",
            "--format",
            "csv",
            "--output",
            output_file,
            filename,
            query,
        ]
        try:
            subprocess.run(command, capture_output=True, text=True, check=True)
        except FileNotFoundError:
            click.echo(f"Error: Command '{command[0]}' not found.", err=True)
        except subprocess.CalledProcessError as e:
            click.echo(f"Error executing command: {e}", err=True)
            click.echo(f"STDOUT: {e.stdout}", err=True)
            click.echo(f"STDERR: {e.stderr}", err=True)

        start_date = datetime.date.today() - datetime.timedelta(days=365)
        end_date = datetime.date.today()

        df = (
            # Read in CSV and convert columns
            pl.read_csv(output_file)
            .with_columns(
                [
                    pl.col("date")
                    .str.strptime(pl.Date, "%Y-%m-%d", strict=False)
                    .alias("date"),
                    pl.col("account"),
                    pl.col("position")
                    .str.strip_chars_start(" ")
                    .str.head(n=-4)
                    .cast(pl.Float64, strict=False)
                    .alias("position"),
                ]
            )
            .filter(
                pl.col("date").is_between(
                    start_date,
                    end_date,
                )
            )
        )

        income = df.filter(
            (
                (pl.col("account").str.contains("^Income"))
                & ~(pl.col("account").str.contains("BVG"))
            )
            | pl.col("account").str.contains("CH:Sozialabzuge")
        ).with_columns(pl.lit("Income").alias("account"))

        expenses = df.filter(
            pl.col("account").str.contains("^Expenses")
            & ~(pl.col("account").str.contains("CH:Sozialabzuge"))
        ).with_columns(pl.lit("Expenses").alias("account"))

        df = (
            income.vstack(expenses)
            .with_columns(pl.lit("summary").alias("summary"))
            .group_by("summary", "account")
            .agg(pl.col("position").sum().alias("position"))
            .pivot(
                index="summary",
                on="account",
                values="position",
            )
            .drop("summary")
            .with_columns(
                [
                    (-pl.col("Income") - pl.col("Expenses")).alias("Saved"),
                    (
                        (-pl.col("Income") - pl.col("Expenses")) / -pl.col("Income")
                    ).alias("Savings Rate"),
                ]
            )
        )

    width = 8
    click.echo(f"Monthly averages between {start_date} and {end_date}:")
    click.echo(f"Income:       {abs(df[0, 'Income']) / 12:>{width}.2f} CHF per month")
    click.echo(f"Expenses:     {abs(df[0, 'Expenses']) / 12:>{width}.2f} CHF per month")
    click.echo(f"Saved:        {df[0, 'Saved'] / 12:>{width}.2f} CHF per month")
    click.echo(f"Savings Rate: {df[0, 'Savings Rate'] * 100:>{width}.2f} %")


if __name__ == "__main__":
    main()
